<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Flovvnetic Chat</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #202020, #2e2e2e);
      color: #fff;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    #chat-box {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }

    .message {
      margin-bottom: 10px;
      padding: 12px;
      border-radius: 8px;
      max-width: 75%;
    }

    .user-message {
      background-color: #4caf50;
      align-self: flex-end;
    }

    .bot-message {
      background-color: #333;
      align-self: flex-start;
    }

    #input-area {
      display: flex;
      border-top: 1px solid #444;
      padding: 10px;
    }

    #user-input {
      flex: 1;
      padding: 10px;
      border-radius: 5px;
      border: none;
      outline: none;
    }

    #send-button {
      padding: 10px 15px;
      background-color: #4caf50;
      color: #fff;
      border: none;
      border-radius: 5px;
      margin-left: 10px;
      cursor: pointer;
    }

    .typing-dots {
      display: flex;
      justify-content: start;
      gap: 5px;
    }

    .typing-dots span {
      width: 6px;
      height: 6px;
      background-color: #ccc;
      border-radius: 50%;
      animation: blink 1s infinite;
    }

    .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
    .typing-dots span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes blink {
      0%, 80%, 100% { opacity: 0.2; }
      40% { opacity: 1; }
    }
  </style>
</head>
<body>
  <div id="chat-box"></div>
  <div id="input-area">
    <input type="text" id="user-input" placeholder="Ask me something..." />
    <button id="send-button">Send</button>
  </div>

  <script>
    const chatBox = document.getElementById('chat-box');
    const userInput = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-button');

    const questionWords = ['what', 'how', 'who', 'why', 'when', 'where', 'which', 'whom', 'whose'];
    const helpingVerbs = ['is', 'am', 'are', 'was', 'were', 'do', 'does', 'did', 'have', 'has', 'had', 'will', 'would', 'shall', 'should', 'can', 'could', 'may', 'might', 'must'];
    const pronouns = ['i', 'you', 'he', 'she', 'it', 'we', 'they', 'me', 'him', 'her', 'us', 'them', 'my', 'your', 'his', 'its', 'our', 'their'];
    const wordsToRemove = ['tell', 'mean', 'meaning'];

    function cleanText(text) {
      return text.toLowerCase().replace(/[^\w\s_]/g, '').split(/\s+/).filter(Boolean);
    }

    function removeSymbols(text) {
      return text.toLowerCase().replace(/[^\w\s]/g, '').trim();
    }

    function similarity(a, b) {
      a = a.toLowerCase();
      b = b.toLowerCase();
      let matches = 0;
      const len = Math.max(a.length, b.length);
      for (let i = 0; i < len; i++) {
        if (a[i] === b[i]) matches++;
      }
      return (matches / len) * 100;
    }

    async function fetchJSON(path) {
      try {
        const res = await fetch(path);
        if (res.ok) return res.json();
      } catch (e) {}
      return null;
    }

    function addMessage(text, type) {
      const msg = document.createElement('div');
      msg.className = type === 'user' ? 'message user-message' : 'message bot-message';
      msg.textContent = text;
      chatBox.appendChild(msg);
      chatBox.scrollTop = chatBox.scrollHeight;
      return msg;
    }

    function addTypingIndicator() {
      const msg = document.createElement('div');
      msg.className = 'message bot-message';
      msg.innerHTML = '<div class="typing-dots"><span></span><span></span><span></span></div>';
      chatBox.appendChild(msg);
      chatBox.scrollTop = chatBox.scrollHeight;
      return msg;
    }

    function getFirstValidWord(text) {
      const words = cleanText(text);
      return words.find(w =>
        !questionWords.includes(w) &&
        !helpingVerbs.includes(w) &&
        !pronouns.includes(w) &&
        !wordsToRemove.includes(w) &&
        w !== '_'
      );
    }

    function extractKeywords(text) {
      const words = cleanText(text);
      return [...new Set(words.filter(word =>
        !questionWords.includes(word) &&
        !helpingVerbs.includes(word) &&
        !pronouns.includes(word) &&
        !wordsToRemove.includes(word) &&
        word !== '_'
      ))];
    }

    async function searchBasic(query) {
      const basicData = await fetchJSON('basic.json');
      if (!basicData) return null;
      const cleanQuery = removeSymbols(query);
      for (let key in basicData) {
        if (removeSymbols(key) === cleanQuery) {
          return basicData[key];
        }
      }
      return null;
    }

    async function searchInFile(path, input, exact = true) {
      const file = await fetchJSON(path);
      if (!file) return null;
      input = input.replace(/_/g, ' ');
      for (let key in file) {
        const keyClean = key.replace(/_/g, ' ');
        const sim = similarity(input, keyClean);
        if (exact && sim > 85) return file[key];
        if (!exact && sim > 65) return file[key];
      }
      return null;
    }

    async function searchAnswer(input) {
      const basic = await searchBasic(input);
      if (basic) return basic;

      const firstWord = getFirstValidWord(input);
      if (!firstWord) return "Sorry, I couldn't understand your question.";
      const letter = firstWord[0];

      let result = await searchInFile(`custom/${letter}.json`, input, true);
      if (result) return result;
      result = await searchInFile(`custom/${letter}.json`, input, false);
      if (result) return result;

      result = await searchInFile(`commen/${letter}.json`, input, true);
      if (result) return result;
      result = await searchInFile(`commen/${letter}.json`, input, false);
      if (result) return result;

      const keywords = extractKeywords(input);
      const responses = [];
      for (let word of keywords) {
        const a = word[0];
        const b = word[1] || 'a';
        const dataFile = await fetchJSON(`data/${a}/${b}.json`);
        if (!dataFile) continue;
        for (let key in dataFile) {
          if (similarity(key, word) > 85) {
            responses.push(dataFile[key]);
            break;
          }
        }
      }
      return responses.length ? responses.join('\n\n') : "Sorry, I am not trained to answer these questions.";
    }

    async function handleSend() {
      const input = userInput.value.trim();
      if (!input) return;
      addMessage(input, 'user');
      userInput.value = '';

      const typingMsg = addTypingIndicator();
      const reply = await searchAnswer(input);
      typingMsg.remove();
      addMessage(reply, 'bot');
    }

    sendBtn.addEventListener('click', handleSend);
    userInput.addEventListener('keypress', e => {
      if (e.key === 'Enter') handleSend();
    });
    window.addEventListener('load', () => userInput.focus());
  </script>
</body>
</html>
