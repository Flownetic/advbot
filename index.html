<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Daisuke v1.2 - AI Chatbot</title>
  <style>
    body { background-color: #121212; color: #e0e0e0; font-family: 'Segoe UI', sans-serif; margin: 0; }
    nav, footer { background: #000; padding: 1.5rem; border-bottom: 2px solid #00ff88; text-align: center; }
    .logo { font-size: 1.8rem; color: #00ff88; text-decoration: none; font-weight: bold; }
    .chatbot-container { max-width: 800px; margin: 2rem auto; background: #1e1e1e; border-radius: 8px; overflow: hidden; border: 1px solid #333; }
    .chatbot-header { background: #000; padding: 1.5rem; border-bottom: 2px solid #00ff88; text-align: center; }
    .chatbot-header h2 { color: #00ff88; }
    .chat-messages { height: 400px; overflow-y: auto; padding: 1.5rem; background: #121212; }
    .message { margin: 1rem 0; padding: 1rem; border-radius: 8px; max-width: 80%; }
    .user-message { background: #003d1f; margin-left: auto; }
    .bot-message { background: #1a1a1a; margin-right: auto; }
    .chat-input-container { display: flex; padding: 1rem; background: #000; border-top: 1px solid #333; }
    #user-input { flex: 1; padding: 0.8rem; background: #1e1e1e; border: 1px solid #333; color: #e0e0e0; }
    #send-button { margin-left: 0.5rem; padding: 0.8rem 1.5rem; background: #00ff88; color: #121212; border: none; cursor: pointer; }
  </style>
</head>
<body>
  <nav><a href="#" class="logo">Daisuke v1.2</a></nav>
  <div class="chatbot-container">
    <div class="chatbot-header">
      <h2>Daisuke AI Assistant</h2>
      <p>Ask anything â€” I search and understand intelligently!</p>
    </div>
    <div class="chat-messages" id="chat-messages">
      <div class="message bot-message">Hi! I'm Daisuke v1.2. Ask me anything.</div>
    </div>
    <div class="chat-input-container">
      <input type="text" id="user-input" placeholder="Type your question..." autofocus />
      <button id="send-button">Send</button>
    </div>
  </div>
  <footer>&copy; 2025 Daisuke AI. All rights reserved.</footer>
  <script>
    const questionWords = ["what", "who", "how", "why", "where", "when", "which", "whom", "whose"];
    const helpingVerbs = ["is", "am", "are", "was", "were", "do", "does", "did", "have", "has", "had", "can", "could", "shall", "should", "will", "would", "may", "might", "must", "being", "been", "be"];
    const pronouns = ["i", "you", "he", "she", "it", "we", "they", "me", "him", "her", "us", "them", "my", "your", "his", "its", "our", "their"];
    const skipWords = [...helpingVerbs, ...pronouns];

    const chatMessages = document.getElementById('chat-messages');
    const userInput = document.getElementById('user-input');
    const sendButton = document.getElementById('send-button');
    const shownResponses = new Set();

    function cleanInput(text) {
      const words = text.toLowerCase().split(/\s+/);
      let filtered = words.filter(word => !questionWords.includes(word));
      if (filtered.length > 0 && helpingVerbs.includes(filtered[0])) {
        filtered.shift(); // remove first helping verb
      }
      return filtered.join(" ");
    }

    function getFirstContentWord(words) {
      return words.find(word => word && !skipWords.includes(word));
    }

    function addMessage(text, sender) {
      const messageDiv = document.createElement('div');
      messageDiv.classList.add('message', sender + '-message');
      messageDiv.innerHTML = text;
      chatMessages.appendChild(messageDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function similarity(s1, s2) {
      const longer = s1.length > s2.length ? s1 : s2;
      const shorter = s1.length > s2.length ? s2 : s1;
      const longerLength = longer.length;
      if (longerLength === 0) return 1.0;
      return (longerLength - editDistance(longer, shorter)) / longerLength;
    }

    function editDistance(s1, s2) {
      const costs = Array(s2.length + 1).fill(0);
      for (let i = 0; i <= s1.length; i++) {
        let lastValue = i;
        for (let j = 0; j <= s2.length; j++) {
          if (i === 0) costs[j] = j;
          else if (j > 0) {
            let newValue = costs[j - 1];
            if (s1[i - 1] !== s2[j - 1]) newValue = Math.min(newValue, lastValue, costs[j]) + 1;
            costs[j - 1] = lastValue;
            lastValue = newValue;
          }
        }
        if (i > 0) costs[s2.length] = lastValue;
      }
      return costs[s2.length];
    }

    async function searchJSON(url, input, thresholds, treatUnderscoreAsSpace) {
      try {
        const res = await fetch(url);
        if (!res.ok) return null;
        const data = await res.json();
        for (const threshold of thresholds) {
          for (const key in data) {
            let keyProcessed = treatUnderscoreAsSpace ? key.replace(/_/g, " ") : key;
            if (similarity(input, keyProcessed.toLowerCase()) >= threshold) {
              const answer = data[key];
              if (!shownResponses.has(answer)) {
                shownResponses.add(answer);
                return answer;
              }
            }
          }
        }
      } catch { return null; }
      return null;
    }

    async function getBotResponse(inputText) {
      const cleaned = cleanInput(inputText);
      const words = cleaned.split(/\s+/);
      const firstLetterWord = getFirstContentWord(words);
      if (!firstLetterWord) return "I couldnâ€™t understand your input.";

      const firstLetter = firstLetterWord[0];
      shownResponses.clear();

      let response = await searchJSON(`custom/${firstLetter}.json`, cleaned, [0.85, 0.65], true);
      if (response) return response;

      response = await searchJSON(`commen/${firstLetter}/${firstLetter}.json`, cleaned, [0.85, 0.65], true);
      if (response) return response;

      const matches = [];
      for (let word of words) {
        const a = word[0], b = word[1];
        if (!a || !b) continue;
        const path = `data/${a}/${b}.json`;
        const match = await searchJSON(path, word, [0.9, 0.4], false);
        if (match && !shownResponses.has(match)) {
          shownResponses.add(match);
          matches.push("ðŸ”¹ " + match);
        }
      }
      return matches.length ? matches.join("<br>") : "I couldnâ€™t find an answer. Try rephrasing.";
    }

    async function sendMessage() {
      const message = userInput.value.trim();
      if (!message) return;
      addMessage(message, 'user');
      userInput.value = '';

      const typing = document.createElement('div');
      typing.className = 'message bot-message';
      typing.textContent = '...';
      chatMessages.appendChild(typing);
      chatMessages.scrollTop = chatMessages.scrollHeight;

      setTimeout(async () => {
        chatMessages.removeChild(typing);
        const response = await getBotResponse(message);
        addMessage("Daisuke: " + response, 'bot');
      }, 600 + Math.random() * 600);
    }

    sendButton.addEventListener('click', sendMessage);
    userInput.addEventListener('keypress', e => { if (e.key === 'Enter') sendMessage(); });
  </script>
</body>
</html>
